<style>
    .top-msg {
      width: 100%;
      position: fixed;
      background-color: rgb(96 42 42 / 60%);
      color: rgba(250,251,255,0.95);
      font-family: "Lato", sans-serif;
      font-size: 18px;
    }
    .top-msg-close {
      float: left;
      box-sizing: border-box;
      padding-top: 17px;
      padding-right: 30px;
      width: 45px;
    }

    .top-msg-inner a {
      text-decoration: none;
      color: RGBA(0, 0, 0, 0.6);
      font-weight: bold;
    }

    .top-msg-inner a:hover {
      color: RGBA(0, 0, 0, 0.5);
    }

    .top-msg-inner {
      float: left;
      box-sizing: border-box;
      padding: 0 10px;
      width: calc(100% - 110px);
    }
    .top-msg-ico {
      float: left;
      width: 65px;
      height: 57px;
      background-color: rgb(203 11 11 / 70%);
      text-align: center;
      font-size: 45px;
    }
    .auth-message {
      height:30px; 
      color:red; 
      background-color: gold;
    }
    .top-msg-close-auth {
      float: right;
      box-sizing: border-box;
      padding-top: 1px;
      padding-right: 30px;
      width: 45px;
      cursor: pointer;
    }
    .usuario-icon {
      padding-right: 10px;
      cursor: pointer;
    }
    #user-left-menu {
      background-color: #FFFFFF;
      display: none;
      position: absolute;
      left: 0px;
      z-index: 1000;
      padding-bottom: 10px;
      padding-top: 10px;
      border-radius: 3px;
    }
    #user-left-menu p {
      padding-left: 20px;
      padding-right: 10px;
    }
    #user-left-menu a {
      color: black;
      text-decoration: none;
    }
    #user-left-menu p:hover {
      background-color:bisque;
    }
    .blues {
      color: cornflowerblue;
    }
    .span-user {
      width: 100px;
      display: inline;
      padding: 10px;
    }
    .input-info {
      width: 100%;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
    }
</style>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="usuario-icon" onclick="userMenu()">
    <img width="30px;" src="images/user.png" alt="Usuario" title="Usuario: <%- username.name%> (<%- username.completo%>)"></img>
  </div>
  <a href="/catalogos">
    <img width="30px;" src="images/logo.jpg" alt="Melamina pro"></img>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav">
      <a class="nav-item nav-link active" href="/productos">Productos<span class="sr-only">(current)</span></a>
      <a class="nav-item nav-link" href="/inventario">Inventario</a>
      <a class="nav-item nav-link" href="/pedidos">Pedidos(Ventas)</a>
      <a class="nav-item nav-link" href="/ingresos">Ingresos(Compras)</a>
      <a class="nav-item nav-link" href="/catalogos">Catalogos</a>
      <a class="nav-item nav-link" href="/reporte">Reportes</a>
      <a class="nav-item nav-link" href="/historial">Historial</a>
      <a class="nav-item nav-link" href="/preferencias">Preferencias</a>
      <a class="nav-item nav-link" style="cursor:pointer;" onclick="$('#about').show()">About</a>
    </div>
  </div>
</nav>

<div id="user-left-menu">
  <a onclick="displayUserInfo()" style="cursor: pointer;">
    <p><ion-icon name="person-circle-outline"></ion-icon>&ensp;<%- username.name%></p>
  </a>
  <a onclick="displayConfiguration()" style="cursor: pointer;">
    <p><ion-icon name="person-circle-outline"></ion-icon>&ensp;Configuracion de Sitio</p>
  </a>
  <hr>
  <a href="/logout">
    <p><ion-icon name="log-out-outline"></ion-icon>&ensp;Logout</p>
  </a>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</div>

<div id="message"></div>

<% if (process.env.message && process.env.message.length) { %>
<div id="auth-message" class="auth-message"><%=process.env.message%>
  <div class="top-msg-close-auth" onclick="$('#auth-message').hide()">&#10005;</div>
</div>
<%   process.env.message = "";  
   } 
%>

<% 
    let alert = 0;

    _inventario.forEach((inventario) => {
        if (inventario.metraje >= 0 ) {
          if (inventario.existencia <= _control["Tapacantos"].minimo) {
            alert++;
          }
        } else if (inventario.metraje == -1 ) {
          if (inventario.existencia <= _control["Melamina"].minimo) {
            alert++;
          }
        } else if (inventario.metraje == -2 ) {
          if (inventario.existencia <= _control["Pegamento"].minimo) {
            alert++;
          }
        } else if (inventario.metraje == -3 ) {
          if (inventario.existencia <= _control["Fondo"].minimo) {
            alert++;
          }
        } else if (inventario.metraje == -4 ) {
          if (inventario.existencia <= _control["Tapatornillos"].minimo) {
            alert++;
          }
        }
    });

    console.log("ALERT!!!",alert);
    if (alert) {
%>
<div class="top-msg" id="alert-message">
  <div class="top-msg-ico">
    !
  </div>
  <div class="top-msg-inner">
    <p>Existen <%-alert %> productos que estan bajo el rango de existencia, Vea el <a style="color:red!important;" href="/inventario">Inventario</a> para obtener mas informacion.</p>
  </div>
  <div class="top-msg-close" style="cursor: pointer;" onclick="$('#alert-message').hide()">&#10005;</div>    
</div>
<% } //end alert %>

<div id="about" style="background: #FFFFFF;position:fixed;margin-left:50%;margin-top:50%;width:400px;height:400px;margin-left:-200px;margin-top:-200px;display:none;top: 50%;left: 50%;border-radius: 10px;">
    <div style="cursor: pointer;float: right;padding: 20px;font-size: 12px;" onclick="$('#about').hide()">&#10005;</div>
    <div style="padding: 50px">
        <h4><a style="color: cornflowerblue;">Melamina Pro</a></h4><br>
        <img width="300px;" src="images/melaninapro_image.png" alt="Melamina pro"></img>
        <br>
        <br>
        <br>
        <p>Welcome to Melamina Pro</p>
        <h4>Version: <%-process.env.npm_package_version %></h4>
    </div>
</div>

<div id="user-info-frame" style="background: #FFFFFF;position:fixed;margin-left:50%;margin-top:50%;width:380px;height:410px;margin-left:-200px;margin-top:-200px;display:none;top: 50%;left: 50%;border-radius: 10px;">
  <div style="cursor: pointer;float: right;padding: 20px;font-size: 12px;" onclick="$('#user-info-frame').hide()">&#10005;</div>
  <div style="padding: 50px; border-radius: 10px; border: 1px solid #d7d7d7; margin:10px;">
      <h4>Melamina Pro User Info</h4><br>
      <h5><span class="blues">Username:</span> <%=username.name %> <%= (username.administrador)?'(Administrador)':'' %></h5><br>
      <h5><span class="blues">Nombre:</span> <%=username.completo %></h5><br>
      <div class="blues">Permissions: </div>
      <div class="blues span-user">&ensp;Preferencias:</div><span><%=username.administrador?'activo':'desactivado' %></span><br>
      <div class="blues span-user">&ensp;Compras:</div><span><%=username.compras?'activo':'desactivado' %></span><br>
      <div class="blues span-user">&ensp;Ventas:</div><span><%=username.ventas?'activo':'desactivado' %></span><br>
  </div>
</div>

<div id="configuration-frame" style="background: #FFFFFF;position:fixed;margin-top:60px;width:90%;height:540px;margin-left:60px;margin-top:0px;display:none;border-radius: 10px;">
  <link type="text/css" rel="stylesheet" href="stylesheets/stylepre.css" />
  <div style="cursor: pointer;float: right;padding: 20px;font-size: 12px;" onclick="$('#configuration-frame').hide()">&#10005;</div>
  <div style="padding: 30px; border-radius: 10px; border: 1px solid #d7d7d7; margin:10px;height: -webkit-fill-available;">
    <div id="leftform"style="width:50%;float:left;padding-right:10px">
      <h4>Configuracion de la aplicaci√≥n</h4><br>
      <h5 class="input-info"><label class="blues" for="name-app">Nombre:</label><input class="form-control" type="text" id="name-app" value="Melamina Pro"></h5>
      <h5 class="input-info"><label class="blues" for="cell1-app">Celular #1:</label><input class="form-control" type="tel" id="cell1-app" value="72225374"></h5>
      <h5 class="input-info"><label class="blues"for="cell2-app">Celular #2:</label><input class="form-control" type="tel" id="cell2-app" value="65225374"></h5>
      <h5 class="input-info"><label class="blues"for="direccion-app">Direccion:</label><input class="form-control" type="text" id="direccion-app" value="Av. Petrolera"></h5>
      <h5 class="input-info"><label class="blues"for="foto-app">Foto:</label><input class="form-control" type="file" accept="image/*" id="foto-app" onchange="onImageSelected(event,'photo-image')"></h5>
      <h5 class="input-info"><label class="blues"for="icono-app">Icono:</label><input class="form-control" type="file" accept="image/*" id="icono-app" onchange="onImageSelected(event,'icon-image')"></h5>
      <button class="submit-btn" type="button" onclick="guardarConfig()">Guardar</button>
    </div>
    <div id="rightform"style="width:50%;float:right;padding-left:10px">
      <input class="form-control" type="hidden" id="token-app" value="">
      <h4><input class="form-control" type="hidden" id="id-app" value="1000"></h4><br>
      <h5 class="input-info"><label class="blues" for="email-app">Email:</label><input class="form-control" type="email" id="email-app" value="user@melamina.com"></h5>
      <h5 class="input-info"><label class="blues" for="tiktok-app">tiltok:</label><input class="form-control" type="text" id="tiktok-app" value="@tiktok:/ffff"></h5>
      <div id="icon-app" style="width:80px; height:80px; border: 1px dashed #918484;padding:20px;float: right;border-radius: 8px;">
        <img id="icon-image" height="40"/>
      </div>
      <div id="photo-app" style="width:65%; height:300px; border: 1px dashed #9b8d8d;padding:20px;border-radius: 8px;">
        <img id="photo-image" height="260"/>
      </div>
    </div>
   </div>
</div>

<script>
function userMenu() {
    let state = document.getElementById("user-left-menu").style.display;
    document.getElementById("user-left-menu").style.display = (state=="none"||state=="")?"block":"none";
}

function displayUserInfo() {
    let state = document.getElementById("user-info-frame").style.display = "block";
    document.getElementById("user-left-menu").style.display = "none";
}

function displayConfiguration() {
    let state;
    fetch('/configuracion/', {
	        method: 'GET',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify(this.att)
	    })
	    .then(response => response.json())
	    .then(response => {
              console.log(response);
              console.log(response.message);
              document.getElementById("token-app").value = response.token;
              document.getElementById("id-app").value = response.config._id.toString();
              document.getElementById("name-app").value = response.config.nombre_app;
              document.getElementById("cell1-app").value = response.config.celular_1;
              document.getElementById("cell2-app").value = response.config.celular_2;
              document.getElementById("direccion-app").value = response.config.direccion;
              document.getElementById("email-app").value = response.config.email;
              document.getElementById("tiktok-app").value = response.config.tiktok_site;
              document.getElementById("photo-image").src  = response.config.foto;
              document.getElementById("icon-image").src  = response.config.icon;
	        if (response.ok) {
              state = document.getElementById("configuration-frame").style.display = "block";
              document.getElementById("user-left-menu").style.display = "none";

	        } else {
				      document.getElementById("message").style.background = "red";
	            document.getElementById("message").innerHTML = response.message + "<br>";
              state = document.getElementById("configuration-frame").style.display = "block";
              document.getElementById("user-left-menu").style.display = "none";
	        }
	    })
	    .catch(error => {
			    document.getElementById("message").style.background = "red";
	        document.getElementById("message").innerHTML = "Error: " + error.message + "<br>";
          document.getElementById("user-left-menu").style.display = "none";
	        console.log(error.message);
	    });
   
}

function onImageSelected(event, imageID) {
    let selectedFile = event.target.files[0];
    let reader = new FileReader();
    let imgtag = document.getElementById(imageID);

    if (!selectedFile) {
      return;
    }

    imgtag.title = selectedFile.name;
    reader.onload = function(event) {
        imgtag.src = event.target.result;
    };

    reader.readAsDataURL(selectedFile);
}

async function uploadImage(inputID, imageID) {
    const fileInput = document.getElementById(inputID);
    const imgtag = document.getElementById(imageID);

    if (typeof fileInput.files === 'undefined'  ||  !fileInput.files ) {
      console.log ("upload: not files ");
      return imgtag.src;
    }
    if (fileInput.files.length <= 0) {
      console.log ("upload: not length ");
      return imgtag.src;
    }

    const file = fileInput.files[0];
    const apiKey = document.getElementById("token-app").value;

    if (!file) {
      console.log ("upload: not first file");
      return imgtag.src;
    }

    const formData = new FormData();
    formData.append('image', file);

    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        console.log('upload: URL de la imagen:', data.data.url); // URL de la imagen subida
        return data.data.url;
    } catch (error) {
        console.error('upload: Error:', error);
    }
}

async function guardarConfig() {
    let id =  document.getElementById("id-app").value;

    let config = {};
    config.nombre_app = document.getElementById("name-app").value; 
    config.celular_1 = document.getElementById("cell1-app").value;
    config.celular_2 = document.getElementById("cell2-app").value;
    config.direccion = document.getElementById("direccion-app").value;
    config.email = document.getElementById("email-app").value;
    config.tiktok_site = document.getElementById("tiktok-app").value;
    config.foto = await uploadImage("foto-app", "photo-image");
    config.icon = await uploadImage("icono-app", "icon-image");
console.log("new foto:", config.foto);
console.log("new icon:", config.icon);
      fetch(`/configuracion/actualizar/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(response => {
            document.getElementById("message").style.background = "#a4f1a4";
            document.getElementById("message").innerHTML = response.message + "<br>";
            document.getElementById("user-left-menu").style.display = "none";
            console.log(response);
        })
        .catch(error => {
            document.getElementById("message").style.background = "red";
            document.getElementById("message").innerHTML = "Error: " + error.message + "<br>";
            document.getElementById("user-left-menu").style.display = "none";
            console.log(error.message);
        });

      document.getElementById("configuration-frame").style.display = "none";
}
</script>